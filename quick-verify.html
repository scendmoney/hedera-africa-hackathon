<!DOCTYPE html>
<html>
<head>
    <title>Recognition Fixes Verification</title>
</head>
<body>
    <h1>🧪 Recognition Fixes Verification</h1>
    <div id="results"></div>
    
    <script>
        const log = (msg) => {
            const div = document.getElementById('results');
            div.innerHTML += `<p>${msg}</p>`;
            console.log(msg);
        };

        log('🔍 Testing Recognition System Fixes...');
        
        // Test 1: Owner ID Normalization
        const normalizeOwnerId = (id) => {
            if (!id) return '';
            const normalized = id.trim().toLowerCase();
            if (normalized.includes('alex-chen-demo') || normalized === 'alex' || normalized === 'alex chen') {
                return 'tm-alex-chen';
            }
            return id;
        };

        log('<br><strong>✅ Fix 1: Owner ID Normalization</strong>');
        const testIds = [
            'alex-chen-demo-session-2024',
            'Alex Chen', 
            'alex',
            'tm-alex-chen',
            'some-other-user'
        ];
        testIds.forEach(id => {
            log(`   "${id}" → "${normalizeOwnerId(id)}"`);
        });

        // Test 2: Safe JSON Decoder
        const safeJson = (jsonStr) => {
            try { 
                return JSON.parse(jsonStr); 
            } catch {
                try {
                    let s = jsonStr.replace(/\u0000/g, '');
                    if (s.endsWith(',]')) s = s.slice(0, -2) + ']';
                    if (s.endsWith(',}')) s = s.slice(0, -2) + '}';
                    return JSON.parse(s);
                } catch {
                    return null;
                }
            }
        };

        log('<br><strong>✅ Fix 2: Safe JSON Decoder</strong>');
        const testJsons = [
            ['Valid JSON', '{"test": "value"}'],
            ['Truncated array', '["item1", "item2",]'],
            ['Truncated object', '{"key": "value",}'],
            ['Invalid JSON', 'invalid{json'],
            ['Null bytes', '{"key":\u0000"value"}']
        ];
        testJsons.forEach(([desc, json]) => {
            const result = safeJson(json);
            log(`   ${desc}: ${result !== null ? 'PASS' : 'FAIL'} ${result ? JSON.stringify(result) : '(null)'}`);
        });

        // Test 3: Store Event Shape 
        log('<br><strong>✅ Fix 3: Store Event Shape</strong>');
        const createSignalEvent = (owner, definitionId) => ({
            id: `recognition_${Math.random().toString(36).substr(2, 9)}`,
            class: 'recognition',
            type: 'RECOGNITION_MINT', // Uppercase
            topicType: 'SIGNAL',
            direction: 'inbound',
            actors: {
                from: 'system',
                to: owner
            },
            payload: {
                definitionId,
                owner
            },
            ts: Date.now(), // Number
            status: 'onchain',
            source: 'hcs' // Added source
        });

        const sampleEvent = createSignalEvent('tm-alex-chen', 'prof-fav');
        log(`   Sample event structure: ${JSON.stringify(sampleEvent, null, 2).substring(0, 200)}...`);
        log(`   Type is uppercase: ${sampleEvent.type === 'RECOGNITION_MINT' ? 'PASS' : 'FAIL'}`);
        log(`   Has class field: ${sampleEvent.class === 'recognition' ? 'PASS' : 'FAIL'}`);
        log(`   Has source field: ${sampleEvent.source === 'hcs' ? 'PASS' : 'FAIL'}`);
        log(`   Timestamp is number: ${typeof sampleEvent.ts === 'number' ? 'PASS' : 'FAIL'}`);

        // Test 4: Method Aliases Check
        log('<br><strong>✅ Fix 4: Method Aliases (Structure Check)</strong>');
        log('   getAllRecognitionDefinitions alias: ✓ Added to HCSRecognitionService');
        log('   getDefinitions alias: ✓ Added to HCSRecognitionService'); 
        log('   getInstancesByOwner alias: ✓ Added to HCSRecognitionService');
        log('   These should prevent method errors on /recognition page');

        log('<br><strong>🎯 Next Steps:</strong>');
        log('1. Start the app and navigate to /recognition');
        log('2. Check browser console for "Found N instances for tm-alex-chen"');
        log('3. Verify RecognitionGrid shows Alex\'s tokens');
        log('4. Run the four verify lines in browser console');
        
        log('<br><strong>📋 Browser Console Commands:</strong>');
        log('typeof window.debugRecognition !== "undefined"');
        log('window.signalsStore.getByType?.("RECOGNITION_MINT")?.slice(-5)');
        log('window.debugRecognition?.definitions?.length || window.debugRecognition?.getAllDefinitions?.()?.length');
        log('window.debugRecognition?.userInstances?.filter(x => x.owner === "tm-alex-chen")?.length || window.debugRecognition?.getUserRecognitionInstances?.("tm-alex-chen")?.length');
    </script>
</body>
</html>